<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>单据识别</title>
    <link rel="stylesheet" href="/static/css/dropzone.min.css">
    <link rel="stylesheet" href="/static/css/dropzone.min.css">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <style type="text/css">
    .container {
        /*margin-top: 70px;*/
    }
    
    .dz-row {
        /*background-color: #E8E9EC;*/
    }
    
    .idcard-result-row {
        /*background-color: #646C7F;*/
        /*color: white;*/
    }
    
    .dropzone {
        border: 2px dashed #0087F7;
        border-radius: 5px;
        background: white;
        margin-top: 50px;
        margin-bottom: 50px;
    }
    
    .dz-message-bold {
        font-size: 30px;
        font-weight: bold;
    }
    
    .dz-message-normal {
        font-size: 25px;
    }
    
    .idcard-preview {
        min-width: 300px;
        min-height: 200px;
        max-width: 500px;
        max-height: 400px;
    }
    .dz-image{
        width:95%;
        height:95%;
    }
    
    hr {
        margin-top: 40px;
        margin-bottom: 0;
    }
    </style>
</head>

<body>
    <div class="container">
        <h3>化验单识别</h3>
        <hr style="margin-top: 0;" />
        <div class="row dz-row">
            <div class="col-md-3"></div>
            <div class="col-md-6">
                <form id="upload_form" class="dropzone" action="{% url 'sm.djangosite.ocr_api.views.views.async_analysis' %}" enctype="multipart/form-data" method="POST">
                    <div class="dz-message text-center">
                        <span class="dz-message-normal">
                        <span class="dz-message-bold">点击</span>或将文件<span class="dz-message-bold">拖拽</span>到这里进行上传
                        </span>
                    </div>
                </form>
            </div>
            <div class="col-md-3"></div>
        </div>
        <hr id="hr_tip" style="display: none;" />
        <div class="row idcard-result-row" style="display: none;">
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <h3 style="display: inline-block;">识别结果：</h3>
                        <strong><div id="progres_tip" style="display: inline-block; color: red;">正在进行云识别……</div></strong>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <img id="img_loading" style="display: none;" src="/static/ocr_api/loading.gif">
                        <a id="result-doc-href" href='#' target="_blank" style="display: none;">Download ocr doc</a>
                        <div id="result-block">
                            <table class="tab table">
                                
                            </table>
                            <table class="table1 table">
                                
                            </table>
                        </div>
                    </div>
                </div>
        </div>
        <hr/>
    </div>
</body>
<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/static/js/dropzone.min.js"></script>
<script type="text/javascript">
Dropzone.autoDiscover = false;
$('#upload_form').dropzone({
    maxFiles: 1,
    acceptedFiles: '.jpg, .png, .bmp, .gif',
    maxfilesexceeded: function(file) {
        this.removeAllFiles();
        this.addFile(file);
    },
    sending: function(file) {

    },
    complete: function(file) {},
    success: function(file, response) {
        if (response.status != 'ok') {
            alert(response.message);
            return false;
        }
        var file_id = response.data.fid;
        console.log(file_id)

        $('.idcard-result-row').css('display', '');
        $('#idcard-preview').css('display', '');
        // $('#img_loading').css('display', '');

        get_ocr_result(file_id);
    }
});

function get_ocr_result(fid) {
    var url = '/api/ocr/async_analysis/result/?fid=' + fid + '&type=info';
    console.log('Requesting ' + url);
    $.get(url, function(data) {
        if (data.status == 'error') {
            alert(data.message);
            $('#img_loading').css('display', '');
            return;
        }
        if (data.status == 'running') {
            setTimeout(function() {
                get_ocr_result(fid);
            }, 1000);
            return;
        }
        var table_str = "";
        var table_header = "";
        var table_th = "";
        $('#progres_tip').html('识别完成！');
        $('#img_loading').css('display', '');
        console.log(data)
        $.each(data.data["indicators"], function(index, data) {
            $.each(data, function(index1, data2) {
                table_str += '<tr><td>' + index + '</td><td>' + index1 + '</td><td>' + data2 + '</td></tr>';
            })
            });
            // $.each(msg["unknown_indicators"], function(index3, data3) {
            //     table_header += '<tr><td>' + data3 + '</td></tr>';
            // });
            $.each(data.data["extra_info"], function(index3, data3) {
                table_th += '<tr><td class="border">' + index3 + '：' + data3 + '</td></tr>';
                h3 = '<h3 style="text-align:center;">' + data.data['extra_info']['医院名称'] + '</h3>'
            });
            // $('.mainImage').after(h3);
            $('.tab').append(table_th);
            $('.table1').append(table_str);
        // var json_str = '';
        // json_str += JSON.stringify(data.data, null, 4);
        // json_str = json_str.replace(/"(.+?)":/ig, '"<strong>$1</strong>":');
        // json_str = json_str.replace(/\n/ig, "<br/>");
        // json_str = json_str.replace(/\s/ig, "&nbsp;");

        // $('#result-block').html(json_str);
        $('#result-block').css('display', '');

        // var timeout = setTimeout(function() {
        //     $('#progres_tip').css('display', '');
        // }, 1000);
    });
}
</script>

</html>
